<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>WRV 캜asov칳 syst칠m - Oprava Admina</title>
    <style>
        :root { 
            --primary: #1a2a6c; --accent: #f21111; --rz-start: #ffcc80; 
            --service: #e3f2fd; --warning: #f39c12; --success: #27ae60;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; }
        
        #admin-panel { display: none; border: 2px solid var(--primary); }
        .login-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; }
        
        .admin-grid { display: grid; grid-template-columns: 1.2fr 0.8fr 0.8fr 1.5fr auto; gap: 10px; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.8em; font-weight: bold; color: #666; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button.danger { background: var(--accent); }

        .admin-list-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .admin-item { background: #f8f9fa; border: 1px solid #ddd; padding: 5px 12px; border-radius: 6px; display: inline-flex; align-items: center; gap: 10px; margin: 3px; font-size: 0.85em; }
        .admin-item b { color: var(--accent); cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; text-align: left; font-size: 0.8em; }
        td { padding: 10px 12px; border-bottom: 1px solid #ddd; }

        .row-rz-start { background-color: var(--rz-start) !important; font-weight: bold; }
        .row-service { background-color: var(--service) !important; font-weight: bold; }
        .row-conflict { border-left: 10px solid var(--accent); background-color: #ffebee; }
        
        .time-cell { font-family: 'Courier New', monospace; font-size: 1.3em; font-weight: bold; }
        .neighbor-info { display: flex; justify-content: space-around; background: #2c3e50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .neighbor-box b { font-size: 1.4em; color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <div class="login-bar" id="login-section">
        <input type="password" id="admin-password" placeholder="Heslo organiz치tora">
        <button onclick="checkPassword()">Vstup pro organiz치tory</button>
    </div>
    <div class="login-bar" id="logout-section" style="display:none;">
        <button onclick="location.reload()" style="background:#666">Odhl치sit a zamknout</button>
    </div>

    <h1>游끠 WRV 캜asov칳 syst칠m</h1>

    <div id="admin-panel" class="card">
        <div style="display: grid; grid-template-columns: 1fr 2.5fr; gap: 20px;">
            <div id="mapping-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px;"></div>
            
            <div>
                <h2>游 콎칤zen칤 z치vodu</h2>
                <div class="admin-grid">
                    <div class="input-group">
                        <label>RZ / Bod</label>
                        <select id="event-target">
                            <option value="B1">RZ Bar치k 1</option>
                            <option value="Z1">RZ Z치dve콏ice 1</option>
                            <option value="B2">RZ Bar치k 2</option>
                            <option value="Z2">RZ Z치dve콏ice 2</option>
                            <option value="B3">RZ Bar치k 3</option>
                            <option value="Z3">RZ Z치dve콏ice 3</option>
                            <option value="B4">RZ Bar치k 4</option>
                            <option value="Z4">RZ Z치dve콏ice 4</option>
                        </select>
                    </div>
                    <div class="input-group"><label>Od startovn칤ho 캜.</label><input type="number" id="event-from-bib" placeholder="캛칤slo na voze"></div>
                    <div class="input-group"><label>Posun (m)</label><input type="number" id="event-val" value="10"></div>
                    <div class="input-group"><label>Pozn치mka</label><input type="text" id="event-reason" placeholder="D콢vod..."></div>
                    <button onclick="addIncident()">Zadat posun</button>
                </div>

                <div class="admin-list-container">
                    <label><b>Aktivn칤 posuny v poli:</b></label>
                    <div id="active-incidents-ui" style="margin-top:5px;"></div>
                </div>

                <div class="admin-list-container" style="border-top:1px solid #eee; margin-top:15px; padding-top:15px;">
                    <label><b>Vypadnut칤 pos치dky ze z치vodu:</b></label>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="number" id="exclude-bib-num" placeholder="Startovn칤 캜.">
                        <button class="danger" onclick="excludeBib()">VYHODIT</button>
                    </div>
                    <div id="active-exclusions-ui" style="margin-top:10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="background: var(--primary); color: white;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:white;">游님 Va코e startovn칤 캜칤slo:</h2>
            <input type="number" id="driver-bib-input" oninput="updateTable()" style="width:120px; font-size:1.6em; text-align:center;">
        </div>
    </div>

    <div id="neighbor-ui"></div>
    <div class="card"><div id="timetable-output"></div></div>
</div>

<script>
    const ADMIN_PASS = "rally2025";
    let incidents = [], bibMapping = {}, excludedBibs = [];
    for(let i=1; i<=100; i++) bibMapping[i] = i;

    function checkPassword() {
        if(document.getElementById('admin-password').value === ADMIN_PASS) {
            document.getElementById('admin-panel').style.display='block';
            document.getElementById('login-section').style.display='none';
            document.getElementById('logout-section').style.display='flex';
            renderMapping();
            renderIncidentsAdmin();
            renderExclusionsAdmin();
        }
    }

    function renderMapping() {
        const c = document.getElementById('mapping-list');
        c.innerHTML = '<h3>Po콏ad칤 -> Start. 캜.</h3>';
        for(let i=1; i<=100; i++) {
            c.innerHTML += `<div style="margin-bottom:5px">${i}. <input type="number" value="${bibMapping[i]}" onchange="bibMapping[${i}]=parseInt(this.value);updateTable();" style="width:55px"></div>`;
        }
    }

    function renderIncidentsAdmin() {
        const ui = document.getElementById('active-incidents-ui');
        ui.innerHTML = incidents.length === 0 ? "<em>콯치dn칠 aktivn칤 posuny.</em>" : incidents.map((inc, idx) => `
            <div class="admin-item">
                ${inc.target} | od 캜.${inc.from} | +${inc.val}m 
                <b onclick="removeIncident(${idx})">[칑]</b>
            </div>
        `).join('');
    }

    function renderExclusionsAdmin() {
        const ui = document.getElementById('active-exclusions-ui');
        ui.innerHTML = excludedBibs.length === 0 ? "<em>V코echny pos치dky v z치vodu.</em>" : excludedBibs.map(bib => `
            <div class="admin-item" style="border-color:var(--accent)">
                캜. ${bib} ODSTOUPIL <b onclick="removeExclusion(${bib})">[칑]</b>
            </div>
        `).join('');
    }

    function addIncident() {
        const target = document.getElementById('event-target').value;
        const from = parseInt(document.getElementById('event-from-bib').value);
        const val = parseInt(document.getElementById('event-val').value);
        const reason = document.getElementById('event-reason').value;
        if(from) {
            incidents.push({ target, from, val, reason });
            renderIncidentsAdmin();
            updateTable();
        }
    }

    function removeIncident(idx) { incidents.splice(idx, 1); renderIncidentsAdmin(); updateTable(); }

    function excludeBib() {
        const b = parseInt(document.getElementById('exclude-bib-num').value);
        if(b && !excludedBibs.includes(b)) {
            excludedBibs.push(b);
            renderExclusionsAdmin();
            updateTable();
        }
    }

    function removeExclusion(bib) { excludedBibs = excludedBibs.filter(b => b !== bib); renderExclusionsAdmin(); updateTable(); }

    const CONFIG = [
        { id: 'S1_OUT', label: 'Service OUT (PEVN칗)', type: 'service', time: '07:50' },
        { id: 'V1', label: 'Vizovice (캛asov치 kontrola)', anchor: 'B1', offset: -5 },
        { id: 'B1', label: 'START RZ Bar치k 1', type: 'rz', time: '08:00', duration: 5 },
        { id: 'B1_F', label: 'C칤l Bar치k 1', type: 'none', anchor: 'B1', offset: 5 },
        { id: 'R1', label: 'Rakov치 (캛asov치 kontrola)', anchor: 'Z1', offset: -5 },
        { id: 'Z1', label: 'START RZ Z치dve콏ice 1', type: 'rz', time: '09:06', duration: 10 },
        { id: 'Z1_F', label: 'C칤l Z치dve콏ice 1', type: 'none', anchor: 'Z1', offset: 10 },
        { id: 'S2_IN', label: 'Service IN (M콢쬰te p콏ijet kdykoli)', type: 'service', anchor: 'S2_OUT', offset: -20 },
        { id: 'S2_OUT', label: 'Service OUT (PEVN칗)', type: 'service', time: '10:35' },
        { id: 'V2', label: 'Vizovice (캛asov치 kontrola)', anchor: 'B2', offset: -5 },
        { id: 'B2', label: 'START RZ Bar치k 2', type: 'rz', time: '10:45', duration: 5 },
        { id: 'B2_F', label: 'C칤l Bar치k 2', type: 'none', anchor: 'B2', offset: 5 },
        { id: 'R2', label: 'Rakov치 (캛asov치 kontrola)', anchor: 'Z2', offset: -5 },
        { id: 'Z2', label: 'START RZ Z치dve콏ice 2', type: 'rz', time: '11:51', duration: 10 },
        { id: 'Z2_F', label: 'C칤l Z치dve콏ice 2', type: 'none', anchor: 'Z2', offset: 10 },
        { id: 'S3_IN', label: 'Service IN (M콢쬰te p콏ijet kdykoli)', type: 'service', anchor: 'S3_OUT', offset: -20 },
        { id: 'S3_OUT', label: 'Service OUT (PEVN칗)', type: 'service', time: '13:20' },
        { id: 'V3', label: 'Vizovice (캛asov치 kontrola)', anchor: 'B3', offset: -5 },
        { id: 'B3', label: 'START RZ Bar치k 3', type: 'rz', time: '13:30', duration: 5 },
        { id: 'B3_F', label: 'C칤l Bar치k 3', type: 'none', anchor: 'B3', offset: 5 },
        { id: 'R3', label: 'Rakov치 (캛asov치 kontrola)', anchor: 'Z3', offset: -5 },
        { id: 'Z3', label: 'START RZ Z치dve콏ice 3', type: 'rz', time: '14:36', duration: 10 },
        { id: 'Z3_F', label: 'C칤l Z치dve콏ice 3', type: 'none', anchor: 'Z3', offset: 10 },
        { id: 'S4_IN', label: 'Service IN (M콢쬰te p콏ijet kdykoli)', type: 'service', anchor: 'S4_OUT', offset: -20 },
        { id: 'S4_OUT', label: 'Service OUT (PEVN칗)', type: 'service', time: '16:05' },
        { id: 'V4', label: 'Vizovice (캛asov치 kontrola)', anchor: 'B4', offset: -5 },
        { id: 'B4', label: 'START RZ Bar치k 4', type: 'rz', time: '16:15', duration: 5 },
        { id: 'B4_F', label: 'C칤l Bar치k 4', type: 'none', anchor: 'B4', offset: 5 },
        { id: 'R4', label: 'Rakov치 (캛asov치 kontrola)', anchor: 'Z4', offset: -5 },
        { id: 'Z4', label: 'START RZ Z치dve콏ice 4', type: 'rz', time: '17:21', duration: 10 },
        { id: 'Z4_F', label: 'C칤l Z치dve콏ice 4', type: 'none', anchor: 'Z4', offset: 10 },
        { id: 'S5_IN', label: 'Service IN (M콢쬰te p콏ijet kdykoli)', type: 'service', anchor: 'PRICE', offset: -25 },
        { id: 'PRICE', label: 'VYHL츼EN칈 V칗SLEDK콡', time: '18:30' }
    ];

    function updateTable() {
        const bib = parseInt(document.getElementById('driver-bib-input').value);
        if(!bib) return;
        if(excludedBibs.includes(bib)) { 
            document.getElementById('timetable-output').innerHTML = "<h2 style='color:red; text-align:center'>POS츼DKA ODSTOUPILA</h2>";
            document.getElementById('neighbor-ui').innerHTML = "";
            return; 
        }

        let order = -1;
        for(let k in bibMapping) { if(bibMapping[k] === bib) order = parseInt(k); }
        let droppedBefore = excludedBibs.filter(b => {
            for(let k in bibMapping) { if(bibMapping[k] === b && parseInt(k) < order) return true; }
            return false;
        }).length;
        const pos = order - 1 - droppedBefore;

        let data = {};
        CONFIG.forEach(s => data[s.id] = { mins: s.time ? timeToMins(s.time) + pos : 0, label: s.label, type: s.type, reason: "", info: "" });

        incidents.forEach(inc => {
            let incOrder = -1;
            for(let k in bibMapping) { if(bibMapping[k] === inc.from) incOrder = parseInt(k); }
            if(order >= incOrder && incOrder !== -1) {
                const targetId = inc.target;
                if(data[targetId]) { data[targetId].mins += inc.val; data[targetId].reason = `+${inc.val}m: ${inc.reason}`; }
            }
        });

        for(let i = CONFIG.length - 1; i >= 0; i--) {
            const s = CONFIG[i];
            if(s.anchor && data[s.anchor]) data[s.id].mins = data[s.anchor].mins + s.offset;
        }

        CONFIG.forEach(s => {
            if(s.id.startsWith('R')) {
                const loop = s.id.charAt(1);
                const minArr = data[`B${loop}_F`].mins + 36;
                if(minArr > data[s.id].mins) {
                    const d = minArr - data[s.id].mins;
                    data[s.id].mins += d; data[`Z${loop}`].mins += d;
                }
            }
            if(s.id.startsWith('Z') && s.id.length === 2) {
                const loop = s.id.charAt(1);
                const serviceInId = (loop === "4") ? 'S5_IN' : `S${parseInt(loop)+1}_IN`;
                const zFinish = data[s.id].mins + 10;
                const limit = data[serviceInId].mins - 20;
                if(zFinish > limit) { data[s.id].conflict = true; data[s.id].info = `STOP! Limit: ${minsToTime(limit)}`; }
            }
        });

        let bf = "---", af = "---";
        for (let i = order - 1; i >= 1; i--) { if (!excludedBibs.includes(bibMapping[i])) { bf = bibMapping[i]; break; } }
        for (let i = order + 1; i <= 100; i++) { if (bibMapping[i] && !excludedBibs.includes(bibMapping[i])) { af = bibMapping[i]; break; } }
        document.getElementById('neighbor-ui').innerHTML = `<div class="neighbor-info"><div>P콏ed: 캜. ${bf}</div><div style="border: 2px solid gold; padding: 0 20px; border-radius: 8px;">Vy: 캜. ${bib}</div><div>Za: 캜. ${af}</div></div>`;

        render(data);
    }

    function timeToMins(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function minsToTime(m) { const h = Math.floor(m / 60) % 24; const min = Math.round(m % 60); return `${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`; }

    function render(data) {
        let h = `<table><tr><th>Bod</th><th>캛as</th><th>Info / Limit</th></tr>`;
        CONFIG.forEach(s => {
            const r = data[s.id]; if(s.type === 'none') return;
            let cls = s.type==='rz'?'row-rz-start':(s.type==='service'?'row-service':'');
            if(r.conflict) cls += ' row-conflict';
            h += `<tr class="${cls}"><td>${r.label}</td><td class="time-cell">${minsToTime(r.mins)}</td><td><b style="color:red;font-size:0.8em">${r.reason}</b><br><span style="font-size:0.75em">${r.info}</span></td></tr>`;
        });
        document.getElementById('timetable-output').innerHTML = h + `</table>`;
    }
</script>
</body>
</html>